name: Deploy GraphQL API to AWS Lambda

on:
  push:
    branches:
      - main
    paths:
      - 'api/**' # Only trigger when backend files change
      - '!api/src/functions/background/**' # Exclude background functions

jobs:
  deploy:
    name: Deploy to AWS Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup npm authentication
        run: |
          echo "@jaedag:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.PAT_TOKEN }}" >> .npmrc
        working-directory: ./api

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd api && npm ci

      - name: Compile TypeScript resolvers
        run: |
          # Create a temp directory for compiled resolvers
          mkdir -p api/temp-compiled-resolvers

          # Copy TypeScript resolvers to the temp directory
          cp -r api/src/resolvers/* api/temp-compiled-resolvers/

          # Create a tsconfig.json file for compilation
          echo '{
            "compilerOptions": {
              "target": "es2018",
              "module": "commonjs",
              "esModuleInterop": true,
              "allowSyntheticDefaultImports": true,
              "resolveJsonModule": true,
              "outDir": "./",
              "strict": false,
              "declaration": false,
              "allowJs": true,
              "skipLibCheck": true
            },
            "include": ["./**/*"],
            "exclude": ["node_modules"]
          }' > api/temp-compiled-resolvers/tsconfig.json

          # Install TypeScript if not already available
          npm install -g typescript

          # Compile TypeScript files
          cd api/temp-compiled-resolvers && tsc

          # Remove any .ts files after compilation
          find . -name "*.ts" -type f -delete
          cd ../..

      - name: Prepare GraphQL function package
        run: |
          # Create a temporary directory for the Lambda package
          mkdir -p lambda-package

          # Copy the GraphQL function files
          cp -r api/src/functions/graphql/* lambda-package/

          # Copy schema directory to the package
          mkdir -p lambda-package/schema
          cp -r api/src/schema/* lambda-package/schema/

          # Copy compiled resolvers to the package
          mkdir -p lambda-package/resolvers
          cp -r api/temp-compiled-resolvers/* lambda-package/resolvers/

          # Install dependencies in the function directory
          cd lambda-package && npm ci --production

      - name: Create deployment package
        run: |
          cd lambda-package
          zip -r ../lambda-package.zip .

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name arn:aws:lambda:eu-west-2:871777052000:function:fl-synago-graphql \
            --zip-file fileb://lambda-package.zip
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

      - name: Notify deployment status
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: deployments
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: 'ðŸš€ Synago GraphQL API Lambda Deployment'
          SLACK_MESSAGE: 'Commit: ${{ github.event.head_commit.message }} - Deploying GraphQL API to AWS Lambda ${{ job.status }}'
