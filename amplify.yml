version: 1
frontend:
  phases:
    preBuild:
      commands:
        - |
          set -euo pipefail

          slack_notify () {
            local text="$1"
            # If SLACK_WEBHOOK isn't set, don't fail the build
            if [ -z "${SLACK_WEBHOOK:-}" ]; then
              echo "SLACK_WEBHOOK not set; skipping Slack notification."
              return 0
            fi
            curl -sS -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${text}\"}" \
              "$SLACK_WEBHOOK" >/dev/null || true
          }

          on_error () {
            local exit_code="$?"
            slack_notify "‚ùå Amplify *preBuild* FAILED\n‚Ä¢ App: fl-admin-portal\n‚Ä¢ Branch: ${AWS_BRANCH:-unknown}\n‚Ä¢ Commit: ${AWS_COMMIT_ID:-unknown}\n‚Ä¢ Exit: ${exit_code}"
            exit "$exit_code"
          }
          trap on_error ERR

          slack_notify "üöÄ Amplify *preBuild* started\n‚Ä¢ App: fl-admin-portal\n‚Ä¢ Branch: ${AWS_BRANCH:-unknown}\n‚Ä¢ Commit: ${AWS_COMMIT_ID:-unknown}"

          # Pick the right secret name based on branch
          # main -> prod/fl-admin-portal
          # anything else -> dev/fl-admin-portal
          if [ "${AWS_BRANCH:-}" = "main" ]; then
            SECRET_ID="prod/fl-admin-portal"
          else
            SECRET_ID="dev/fl-admin-portal"
          fi
          echo "Using Secrets Manager secret: $SECRET_ID (branch: ${AWS_BRANCH:-unknown})"

          # Fetch secrets from AWS Secrets Manager
          export SECRET_JSON="$(aws secretsmanager get-secret-value --secret-id "$SECRET_ID" --query SecretString --output text)"

          # Export all secrets as environment variables (safe-ish if values have no spaces)
          export $(echo "$SECRET_JSON" | jq -r 'to_entries | map("\(.key)=\(.value|tostring)") | .[]')

          # Create .env file for Vite with all VITE_ prefixed variables
          echo "$SECRET_JSON" | jq -r '
            to_entries
            | map(select(.key | startswith("VITE_")))
            | map("\(.key)=\(.value|tostring)")
            | .[]
          ' > web-react-ts/.env

          # Configure GitHub Packages authentication for @jaedag scope
          echo "@jaedag:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> .npmrc

          # Install root dependencies
          npm install

          # Install frontend dependencies with GitHub token
          cd web-react-ts
          cp ../.npmrc .
          npm install
          cd ..

          slack_notify "‚úÖ Amplify *preBuild* completed\n‚Ä¢ App: fl-admin-portal\n‚Ä¢ Branch: ${AWS_BRANCH:-unknown}\n‚Ä¢ Commit: ${AWS_COMMIT_ID:-unknown}"

    build:
      commands:
        - |
          set -euo pipefail

          slack_notify () {
            local text="$1"
            if [ -z "${SLACK_WEBHOOK:-}" ]; then
              echo "SLACK_WEBHOOK not set; skipping Slack notification."
              return 0
            fi
            curl -sS -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${text}\"}" \
              "$SLACK_WEBHOOK" >/dev/null || true
          }

          on_error () {
            local exit_code="$?"
            slack_notify "‚ùå Amplify *build* FAILED\n‚Ä¢ App: fl-admin-portal\n‚Ä¢ Branch: ${AWS_BRANCH:-unknown}\n‚Ä¢ Commit: ${AWS_COMMIT_ID:-unknown}\n‚Ä¢ Exit: ${exit_code}"
            exit "$exit_code"
          }
          trap on_error ERR

          slack_notify "üõ†Ô∏è Amplify *build* started\n‚Ä¢ App: fl-admin-portal\n‚Ä¢ Branch: ${AWS_BRANCH:-unknown}\n‚Ä¢ Commit: ${AWS_COMMIT_ID:-unknown}"

          cd web-react-ts
          npm run generate-build-version
          npm run build
          cd ..

          slack_notify "üéâ Amplify *build* SUCCESS\n‚Ä¢ App: fl-admin-portal\n‚Ä¢ Branch: ${AWS_BRANCH:-unknown}\n‚Ä¢ Commit: ${AWS_COMMIT_ID:-unknown}"

  artifacts:
    baseDirectory: web-react-ts/dist
    files:
      - '**/*'

  cache:
    paths:
      - node_modules/**/*
      - web-react-ts/node_modules/**/*
