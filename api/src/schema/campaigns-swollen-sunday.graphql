type SwellStats {
  attendance: Int
  date: Date
  target: Int
}

extend type Oversight {
  swellBussingRecords(startDate: String!, endDate: String!): [SwellStats!]!
    @cypher(
      statement: """
      MATCH (this)
      MATCH (swell:SwellDate)
      WHERE date(swell.date) >= date($startDate) AND date(swell.date) <= date($endDate)
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING_AGGREGATE]->(aggregate:AggregateBussingRecord)
      OPTIONAL MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_TARGET]->(target:Target)-[:TARGET_FOR]->(swell)

      WITH collect(DISTINCT(date(swell.date).week)) as list, aggregate, swell, target
      MATCH (aggregate) WHERE aggregate.week IN list
      RETURN {attendance: toFloat(aggregate.attendance), date: swell.date, target: target.target}
      """
    )
}

extend type GatheringService {
  swellBussingRecords(
    startDate: String!
    endDate: String!
  ): [AggregateBussingRecord!]!
    @cypher(
      statement: """
       MATCH (this)
      MATCH (swell:SwellDate)
      WHERE date(swell.date) >= date($startDate) AND date(swell.date) <= date($endDate)
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING_AGGREGATE]->(aggregate:AggregateBussingRecord)
      OPTIONAL MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_TARGET]->(target:Target)-[:TARGET_FOR]->(swell)

      WITH collect(DISTINCT(date(swell.date).week)) as list, aggregate, swell, target
      MATCH (aggregate) WHERE aggregate.week IN list
      RETURN {attendance: toFloat(aggregate.attendance), date: swell.date, target: target.target}
      """
    )
}

extend type Stream {
  swellBussingRecords(startDate: String!, endDate: String!): [SwellStats!]!
    @cypher(
      statement: """
      MATCH (this)
        MATCH (swell:SwellDate)
        WHERE date(swell.date) >= date($startDate) AND date(swell.date) <= date($endDate)
        MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING_AGGREGATE]->(aggregate:AggregateBussingRecord)
        OPTIONAL MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_TARGET]->(target:Target)-[:TARGET_FOR]->(swell)

        WITH collect(DISTINCT(date(swell.date).week)) as list, aggregate, swell, target
        MATCH (aggregate) WHERE aggregate.week IN list
        RETURN {attendance: toFloat(aggregate.attendance), date: swell.date, target: target.target}
      """
    )
}

extend type Council {
  swellBussingRecords(startDate: String!, endDate: String!): [SwellStats!]!
    @cypher(
      statement: """
      MATCH (this)
      MATCH (swell:SwellDate)
      WHERE date(swell.date) >= date($startDate) AND date(swell.date) <= date($endDate)
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING_AGGREGATE]->(aggregate:AggregateBussingRecord)
      OPTIONAL MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_TARGET]->(target:Target)-[:TARGET_FOR]->(swell)

      WITH collect(DISTINCT(date(swell.date).week)) as list, aggregate, swell, target
      MATCH (aggregate) WHERE aggregate.week IN list
      RETURN {attendance: toFloat(aggregate.attendance), date: swell.date, target: target.target}
      """
    )
}

extend type Constituency {
  swellBussingRecords(
    startDate: String!
    endDate: String!
  ): [AggregateBussingRecord!]!
    @cypher(
      statement: """
      MATCH (this)
      MATCH (swell:SwellDate)
      WHERE date(swell.date) >= date($startDate) AND date(swell.date) <= date($endDate)
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING_AGGREGATE]->(aggregate:AggregateBussingRecord)
      OPTIONAL MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_TARGET]->(target:Target)-[:TARGET_FOR]->(swell)

      WITH collect(DISTINCT(date(swell.date).week)) as list, aggregate, swell, target
      MATCH (aggregate) WHERE aggregate.week IN list
      RETURN {attendance: toFloat(aggregate.attendance), date: swell.date, target: target.target}
      """
    )
}

extend type Bacenta {
  swellBussingRecords(
    startDate: String!
    endDate: String!
  ): [AggregateBussingRecord!]!
    @cypher(
      statement: """
      MATCH (this)
      MATCH (swell:SwellDate)
      WHERE date(swell.date) >= date($startDate) AND date(swell.date) <= date($endDate)
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING_AGGREGATE]->(aggregate:AggregateBussingRecord)
      OPTIONAL MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_TARGET]->(target:Target)-[:TARGET_FOR]->(swell)

      WITH collect(DISTINCT(date(swell.date).week)) as list, aggregate, swell, target
      MATCH (aggregate) WHERE aggregate.week IN list
      RETURN {attendance: toFloat(aggregate.attendance), date: swell.date, target: target.target}
      """
    )
}
