type AccountTransaction {
  id: ID!
  createdAt: DateTime!
  lastModified: DateTime!
  description: String!
  account: String!
  amount: Float!
  charge: Float
  category: String!
  status: String!

  momoNumber: String
  momoName: String
  invoiceUrl: String

  council: Council! @relationship(type: "HAS_TRANSACTION", direction: IN)
  loggedBy: Member! @relationship(type: "LOGGED_BY", direction: OUT)

  bussingSocietyBalance: Float!
  weekdayBalance: Float!
}

extend type Oversight {
  hrAmount: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(council:Council)
      RETURN SUM(council.hrAmount)
      """
      columnName: "hrAmount"
    )
  bussingAmount: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(council:Council)
      RETURN SUM(council.bussingAmount)
      """
      columnName: "bussingAmount"
    )
  weekdayBalance: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(council:Council)
      RETURN SUM(council.weekdayBalance)
      """
      columnName: "weekdayBalance"
    )
  bussingSocietyBalance: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(council:Council)
      RETURN SUM(council.bussingSocietyBalance)
      """
      columnName: "bussingSocietyBalance"
    )
}

extend type Campus {
  hrAmount: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(council:Council)
      RETURN SUM(council.hrAmount)
      """
      columnName: "hrAmount"
    )
  bussingAmount: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(council:Council)
      RETURN SUM(council.bussingAmount)
      """
      columnName: "bussingAmount"
    )
  weekdayBalance: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(council:Council)
      RETURN SUM(council.weekdayBalance)
      """
      columnName: "weekdayBalance"
    )
  bussingSocietyBalance: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(council:Council)
      RETURN SUM(council.bussingSocietyBalance)
      """
      columnName: "bussingSocietyBalance"
    )
  transactions: [AccountTransaction!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(council:Council)
      MATCH (council)-[:HAS_TRANSACTION]->(transaction:AccountTransaction)

      RETURN transaction ORDER BY transaction.lastModified DESC
      """
      columnName: "transactions"
    )
}

extend type Stream {
  hrAmount: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(council:Council)
      RETURN SUM(council.hrAmount)
      """
      columnName: "hrAmount"
    )
  bussingAmount: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(council:Council)
      RETURN SUM(council.bussingAmount)
      """
      columnName: "bussingAmount"
    )
  weekdayBalance: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(council:Council)
      RETURN SUM(council.weekdayBalance)
      """
      columnName: "weekdayBalance"
    )
  bussingSocietyBalance: Float!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(council:Council)
      RETURN SUM(council.bussingSocietyBalance)
      """
      columnName: "bussingSocietyBalance"
    )
  transactions: [AccountTransaction!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(council:Council)
      MATCH (council)-[:HAS_TRANSACTION]->(transaction:AccountTransaction)

      RETURN transaction ORDER BY transaction.lastModified DESC
      """
      columnName: "transactions"
    )
}

extend type Council {
  hrAmount: Float
  bussingAmount: Float
  weekdayBalance: Float!
  bussingSocietyBalance: Float
  transactions: [AccountTransaction!]!
    @relationship(type: "HAS_TRANSACTION", direction: OUT)
}

extend type Mutation {
  SetCouncilHRAmount(councilId: ID!, amount: Float!): Council!
    @authentication(jwt: { roles_INCLUDES: "adminCampus" })
    @cypher(
      statement: """
      MATCH (council:Council {id: $councilId})
        SET council.hrAmount = $amount
      RETURN council
      """
      columnName: "council"
    )
  DepositIntoCouncilCurrentAccount(
    councilId: ID!
    weekdayBalanceDepositAmount: Float!
  ): AccountTransaction!

  DepositIntoCouncilBussingSociety(
    councilId: ID!
    bussingSocietyBalance: Float!
  ): AccountTransaction!

  ExpenseRequest(
    councilId: ID!
    expenseAmount: Float!
    expenseCategory: String!
    accountType: String!
    description: String! #momoNumber: String! #momoName: String! #invoiceUrl: String!
  ): AccountTransaction!
    @authentication(jwt: { roles_INCLUDES: ["leaderCouncil", "adminCampus"] })
    @cypher(
      statement: """
      MATCH (council:Council {id: $councilId})
      MATCH (requester:Member {auth_id: $auth.jwt.sub})

      WITH council, requester

      CREATE (transaction:AccountTransaction {id: randomUUID()})
        SET transaction.description = $description,
        transaction.amount = $expenseAmount *  -1,
        transaction.account = $accountType,
        transaction.category = $expenseCategory,
        transaction.status = 'pending approval',
        transaction.createdAt = datetime(),
        transaction.lastModified = datetime(),
        transaction.bussingSocietyBalance = council.bussingSocietyBalance,
        transaction.weekdayBalance = council.weekdayBalance
        // transaction.momoNumber = $momoNumber,
        // transaction.momoName = $momoName,
        // transaction.invoiceUrl = $invoiceUrl

      MERGE (council)-[:HAS_TRANSACTION]->(transaction)
      MERGE (requester)<-[:LOGGED_BY]-(transaction)

      RETURN transaction
      """
      columnName: "transaction"
    )

  ApproveExpense(transactionId: ID!, charge: Float!): AccountTransaction!

  DeclineExpense(transactionId: ID!): AccountTransaction!
    @authentication(jwt: { roles_INCLUDES: ["adminCampus", "leaderCampus"] })
    @cypher(
      statement: """
      MATCH (transaction:AccountTransaction {id: $transactionId})
        SET transaction.status = 'declined'

      RETURN transaction
      """
      columnName: "transaction"
    )
  UndoBussingTransaction(transactionId: ID!): Council!
    @cypher(
      statement: """
      MATCH (transaction:AccountTransaction {id: $transactionId})<-[:HAS_TRANSACTION]-(council:Council)

        SET council.bussingSocietyBalance = council.bussingSocietyBalance - transaction.amount
      DETACH DELETE transaction

      RETURN council
      """
      columnName: "council"
    )
  UndoWeekdayTransaction(transactionId: ID!): Council!
    @cypher(
      statement: """
      MATCH (transaction:AccountTransaction {id: $transactionId})<-[:HAS_TRANSACTION]-(council:Council)

        SET council.weekdayBalance = council.weekdayBalance - transaction.amount
      DETACH DELETE transaction

      RETURN council
      """
      columnName: "council"
    )

  DebitBussingSociety(
    councilId: ID!
    expenseAmount: Float!
    expenseCategory: String!
  ): AccountTransaction!
}
